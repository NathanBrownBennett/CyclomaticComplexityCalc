<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Setup 2FA</title>
        <link rel="stylesheet" href="../static/style.css">
        <style>
            .qr-code-placeholder {
                display: flex;
                justify-content: center;
                align-items: center;
                height: 200px;
                width: 100%;
                background: transparent;
            }
            .qr-code-placeholder img {
                max-width: 100%;
                max-height: 100%;
            }
            /* Add this to your CSS */
            .modal {
                display: none;
                position: fixed;
                z-index: 1;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                overflow: auto;
                background-color: rgba(0,0,0,0.4);
            }
            .modal-content {
                background-color: #f5f5f5; /* Same as the panel background color */
                color: #333; /* Same as the panel text color */
                margin: 15% auto;
                padding: 20px;
                border: 1px solid #888;
                width: 30%;
            }
            .close {
                color: #aaa;
                float: right;
                font-size: 28px;
                font-weight: bold;
            }
            .close:hover,
            .close:focus {
                color: black;
                text-decoration: none;
                cursor: pointer;
            }
            .verify-button {
                background-color: #4CAF50; /* Green */
                color: white;
                border: none;
                padding: 15px 32px;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 16px;
                margin: 4px 2px;
                cursor: pointer;
            }
            .verification-input {
                margin-right: 5px; /* Space between inputs */
                text-align: center;
                width: 25px; /* Slightly wider */
                height: 30px; /* Slightly taller */
            }

            .error-message {
                display: none;
            }

        </style>
    </head>
<body>
    <script>

    window.onload = function() {

        // Add this to your JavaScript
        document.getElementById('done-button').addEventListener('click', function(evt) {
            evt.preventDefault();
            document.getElementById('verification-modal').style.display = "block";
        });

        document.getElementsByClassName('close')[0].addEventListener('click', function() {
            document.getElementById('verification-modal').style.display = "none";
        });

        window.addEventListener('click', function(event) {
            if (event.target == document.getElementById('verification-modal')) {
                document.getElementById('verification-modal').style.display = "none";
            }
        });

        for (let i = 1; i <= 6; i++) {
            let input = document.getElementById('digit-' + i);
            input.addEventListener('input', function() {
                // Only allow numbers
                this.value = this.value.replace(/[^0-9]/g, '');
                if (this.value.length == this.maxLength) {
                    if (i < 6) {
                        document.getElementById('digit-' + (i + 1)).focus();
                    } else {
                        // Submit the form
                        let code = '';
                        for (let j = 1; j <= 6; j++) {
                            code += document.getElementById('digit-' + j).value;
                        }
                        let xhr = new XMLHttpRequest();
                        xhr.open("POST", "/api/verify");
                        xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                        xhr.onload = function () {
                            if (xhr.status === 200) {
                                document.getElementById('verification-modal').style.display = "none";
                                location.href = 'Index';
                            } else {
                                document.getElementById('error-message').textContent = "Invalid code. Please try again.";
                            }
                        };
                        xhr.send(JSON.stringify({ code: code }));
                    }
                }
            });
        }
    }

    </script>

    <!-- Add this at the end of your body tag -->
    <div id="verification-modal" class="modal">
        <div class="modal-content">
            <span class="close">Ã—</span>
            <h2>Verify Your Setup</h2>
            <p>Please enter the 6-digit code generated by your 2FA app:</p>
            <form id="verification-form">
                <input type="text" id="digit-1" name="digit-1" maxlength="1" required class="verification-input">
                <input type="text" id="digit-2" name="digit-2" maxlength="1" required class="verification-input">
                <input type="text" id="digit-3" name="digit-3" maxlength="1" required class="verification-input">
                <input type="text" id="digit-4" name="digit-4" maxlength="1" required class="verification-input">
                <input type="text" id="digit-5" name="digit-5" maxlength="1" required class="verification-input">
                <input type="text" id="digit-6" name="digit-6" maxlength="1" required class="verification-input">
                <button type="submit" class="verify-button">Verify</button>
            </form>
            <div id="error-message" class="error-message"></div>
        </div>
    </div>


    <div class="navbar">
        <a href="Index">Home</a>
        <a href="AboutUs">About Us</a>
        <a href="Privacy">Privacy</a>
    </div>

    <div class="panel">
        <div class="setup-container">
            <h1>Setup Two-Factor Authentication (2FA)</h1>
            <div class="setup-section">
                <h2>Why 2FA?</h2>
                <p>Two-Factor Authentication adds an extra layer of security to your account. Even if someone knows your password, they won't be able to access your account without also having access to your phone.</p>
            </div>

            <div class="setup-section">
                <h2>How It Protects You</h2>
                <p>Each time you log in, you'll enter your password and a unique code generated by an app on your phone. This makes it much harder for unauthorized people to access your account.</p>
            </div>

            <div class="setup-section">
                <h2>Scan the QR Code</h2>
                <p>Use your 2FA app to scan this QR code. We recommend using apps like Google Authenticator or Authy.</p>
                <div class="qr-code-placeholder">
                    <img src="{{ qr_code }}" alt="QR Code">
                </div>
            </div>

            <div class="setup-section">
                <h2>Manual Setup</h2>
                <p>If you can't scan the QR code, enter this key manually into your 2FA app:</p>
                <strong>{{ totp_uri.split('=')[1].split('&')[0] }}</strong>
            </div>

            <button id="done-button">I'm Done Setting Up</button>
        </div>
    </div>

</body>
</html>
